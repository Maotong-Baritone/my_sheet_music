<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>äºèŒ‚åŒçš„ä¹è°±åº“ | Maotong's Scores</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #264653;
            --accent-color: #e76f51;
            --bg-color: #fdfbf7;
            --card-bg: #ffffff;
            --text-main: #2b2d42;
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Lato', sans-serif; 
            color: var(--text-main);
            display: flex; flex-direction: column; min-height: 100vh; 
        }

        .font-serif { font-family: 'Playfair Display', serif; }
        .container { flex: 1; }
        
        /* å¯¼èˆªæ  */
        .navbar {
            background: rgba(38, 70, 83, 0.9) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Hero åŒºåŸŸ */
        .hero-section {
            background: linear-gradient(135deg, #264653 0%, #2a9d8f 100%);
            padding: 4rem 0 6rem 0;
            margin-bottom: -4rem;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 20%),
                              radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 20%);
            pointer-events: none;
        }

        /* æœç´¢æ¡† */
        .search-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px; border-radius: 50px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
        }

        /* å¡ç‰‡è®¾è®¡ */
        .category-card {
            border: none; border-radius: 16px; transition: all 0.3s ease;
            height: 100%; background: var(--card-bg); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02), 0 10px 20px rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .cat-header { 
            padding: 1.2rem; font-family: 'Playfair Display', serif; font-weight: 700; 
            font-size: 1.1rem; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        
        .list-group-item {
            border: none; border-bottom: 1px solid #f0f0f0; padding: 0.8rem 1.2rem;
            transition: background 0.2s; font-size: 0.95rem;
        }
        .list-group-item:hover { background-color: #f8f9fa; color: var(--primary-color); }
        .list-group-item.active-cat {
            background-color: #eef4ed; color: #264653; font-weight: bold; border-left: 4px solid #2a9d8f;
        }

        .content-section { margin-top: 3rem; }
        
        .table-custom thead th {
            border-top: none; border-bottom: 2px solid #e9ecef;
            font-family: 'Playfair Display', serif; color: #6c757d; font-weight: 700;
        }
        .hover-row { transition: background 0.2s; border-radius: 8px; }
        .hover-row:hover { background-color: #fffcf5; cursor: pointer; }
        
        footer { 
            background-color: #264653; color: #a8b2d1; padding: 4rem 0; margin-top: 5rem; font-family: 'Playfair Display', serif;
        }

        /* æ ‡ç­¾é¢œè‰² */
        .badge-custom { font-weight: 500; border-radius: 4px; padding: 0.4em 0.6em; }
        .bg-opera { background-color: #d00000; color: white; }
        .bg-oratorio { background-color: #7209b7; color: white; }
        .bg-cantata { background-color: #3f37c9; color: white; }
        .bg-artsong { background-color: #4895ef; color: white; }
        .bg-musical { background-color: #f72585; color: white; }
        .bg-solo { background-color: #f48c06; color: white; }
        .bg-cycle { background-color: #0096c7; color: white; }
        .bg-book { background-color: #9d6b53; color: white; }
        .bg-opera-ens { background-color: #6a040f; color: white; }
        .bg-musical-ens { background-color: #560bad; color: white; }
        .bg-sacred-ens { background-color: #3a0ca3; color: white; }
        .bg-artsong-ens { background-color: #bde0fe; color: #264653; }
        .bg-choral { background-color: #2a9d8f; color: white; }
        .bg-inst-solo { background-color: #e9c46a; color: #333; }
        .bg-chamber { background-color: #606c38; color: white; }
        .bg-score-opera { background-color: #212529; color: #f8f9fa; }
        .bg-score-orch { background-color: #343a40; color: #f8f9fa; }
        .bg-score-con { background-color: #495057; color: white; }
        .bg-score-sac { background-color: #6c757d; color: white; }
        .bg-other { background-color: #e9ecef; color: #495057; }

        .btn-primary { background-color: #2a9d8f; border-color: #2a9d8f; }
        .btn-primary:hover { background-color: #21867a; border-color: #21867a; }
        .btn-outline-primary { color: #2a9d8f; border-color: #2a9d8f; }
        .btn-outline-primary:hover { background-color: #2a9d8f; border-color: #2a9d8f; color: white; }

        /* === ğŸ“– å‰§æœ¬é˜…è¯»å™¨æ ·å¼ === */
        #readerContent {
            white-space: pre-wrap; /* ä¿æŒæ®µè½æ¢è¡Œ */
            line-height: 1.8;
        }
        .reader-text-col {
            padding: 2rem;
            font-size: 1.05rem;
        }
        .reader-original {
            background-color: #fff;
            border-right: 1px solid #eee;
            color: #333;
            font-family: 'Playfair Display', serif; /* åŸæ–‡ç”¨è¡¬çº¿ä½“æ›´ä¼˜é›… */
        }
        .reader-translation {
            background-color: #fafafa;
            color: #555;
            font-family: 'Lato', sans-serif;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top">
        <div class="container">
            <span class="navbar-brand mb-0 h1 fw-bold font-serif fs-3">ğŸ¹ äºèŒ‚åŒçš„ä¹è°±åº“</span>
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="showLogModal()">ğŸ”” åŠ¨æ€</button>
                <div class="text-end">
                    <span class="badge bg-warning text-dark me-2">v0.1</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <div class="container position-relative" style="z-index: 2;">
            <h1 class="font-serif display-4 fw-bold mb-3">Music Collection</h1>
            <p class="text-white-50 mb-5 font-serif fst-italic fs-5">"Sharing music, preserving art."</p>
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="input-group input-group-lg search-container">
                        <span class="input-group-text bg-transparent border-0 ps-3 text-muted">ğŸ”</span>
                        <input type="text" id="searchInput" class="form-control border-0 bg-transparent" placeholder="Search title, composer, opus..." style="box-shadow: none;">
                        <button class="btn btn-primary rounded-pill px-4 fw-bold" type="button" onclick="performSearch()">æœç´¢</button>
                    </div>
                    <div class="mt-4 d-flex flex-column align-items-center gap-2">
                        <button class="btn btn-link text-white text-decoration-none opacity-75 hover-opacity-100" onclick="resetFilters()">ğŸŒŸ æŸ¥çœ‹å®Œæ•´åˆ—è¡¨ (View All)</button>
                        <div class="d-flex gap-4 text-white-50 mt-1 small font-serif">
                            <span>ğŸ“š Total: <span id="statTotal" class="text-white fw-bold">0</span></span>
                            <span>ğŸ‘¤ Composers: <span id="statComposer" class="text-white fw-bold">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="height: 60px; overflow: hidden; margin-top: -50px; position: relative; z-index: 1;">
        <svg viewBox="0 0 500 150" preserveAspectRatio="none" style="height: 100%; width: 100%;">
            <path d="M0.00,49.98 C149.99,150.00 349.20,-49.98 500.00,49.98 L500.00,150.00 L0.00,150.00 Z" style="stroke: none; fill: var(--bg-color);"></path>
        </svg>
    </div>

    <div class="container position-relative mt-4" style="z-index: 10;">
        <div class="row g-4">
            <div class="col-lg-4 col-md-6">
                <div class="category-card">
                    <div class="cat-header text-primary bg-light bg-opacity-50">ğŸ¤ å£°ä¹ä½œå“ <span class="small text-muted fw-normal d-block mt-1" style="font-size:0.8rem">Vocal Music</span></div>
<div class="list-group list-group-flush category-group">
    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('æ­Œå‰§å’å¹è°ƒ', this)">æ­Œå‰§å’å¹è°ƒ <span class="badge bg-light text-dark count-badge" data-cat="æ­Œå‰§å’å¹è°ƒ">0</span></button>
    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('æ­Œå‰§é‡å”±', this)">æ­Œå‰§é‡å”± <span class="badge bg-light text-dark count-badge" data-cat="æ­Œå‰§é‡å”±">0</span></button>
    
    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å®—æ•™å£°ä¹ä½œå“', this)">
        å®—æ•™å£°ä¹ä½œå“ 
        <span class="badge bg-light text-dark count-badge" data-cat="å®—æ•™å£°ä¹ä½œå“">0</span>
    </button>
    
    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('è‰ºæœ¯æ­Œæ›²', this)">è‰ºæœ¯æ­Œæ›² <span class="badge bg-light text-dark count-badge" data-cat="è‰ºæœ¯æ­Œæ›²">0</span></button>
    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('éŸ³ä¹å‰§é€‰æ®µ', this)">éŸ³ä¹å‰§é€‰æ®µ <span class="badge bg-light text-dark count-badge" data-cat="éŸ³ä¹å‰§é€‰æ®µ">0</span></button>
    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="category-card">
                    <div class="cat-header text-success bg-light bg-opacity-50">ğŸ“š æ›²é›†ä¸å™¨ä¹ <span class="small text-muted fw-normal d-block mt-1" style="font-size:0.8rem">Collections & Inst.</span></div>
                    <div class="list-group list-group-flush category-group">
                        <div class="py-2 bg-light text-center small text-muted fw-bold border-bottom font-serif">COLLECTIONS</div>
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å£°ä¹å¥—æ›²', this)">å£°ä¹å¥—æ›² <span class="badge bg-light text-dark count-badge" data-cat="å£°ä¹å¥—æ›²">0</span></button>
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('ä¹è°±ä¹¦/æ›²é›†', this)">ä¹è°±ä¹¦/æ›²é›† <span class="badge bg-light text-dark count-badge" data-cat="ä¹è°±ä¹¦/æ›²é›†">0</span></button>
                    </div>
                    <div class="list-group list-group-flush category-group mt-3">
                         <div class="py-2 bg-light text-center small text-muted fw-bold border-top border-bottom font-serif">INSTRUMENTAL</div>
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å™¨ä¹ç‹¬å¥', this)">å™¨ä¹ç‹¬å¥ <span class="badge bg-light text-dark count-badge" data-cat="å™¨ä¹ç‹¬å¥">0</span></button>
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å®¤å†…ä¹', this)">å®¤å†…ä¹ <span class="badge bg-light text-dark count-badge" data-cat="å®¤å†…ä¹">0</span></button>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="category-card">
                    <div class="cat-header text-danger bg-light bg-opacity-50">ğŸ¼ æ€»è°± <span class="small text-muted fw-normal d-block mt-1" style="font-size:0.8rem">Full Scores</span></div>
                    <div class="list-group list-group-flush category-group">
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('æ­Œå‰§æ€»è°±', this)">æ­Œå‰§æ€»è°± <span class="badge bg-light text-dark count-badge" data-cat="æ­Œå‰§æ€»è°±">0</span></button>
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('ç®¡å¼¦ä¹/äº¤å“æ›²', this)">ç®¡å¼¦ä¹/äº¤å“æ›² <span class="badge bg-light text-dark count-badge" data-cat="ç®¡å¼¦ä¹/äº¤å“æ›²">0</span></button>
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('åå¥æ›²æ€»è°±', this)">åå¥æ›²æ€»è°± <span class="badge bg-light text-dark count-badge" data-cat="åå¥æ›²æ€»è°±">0</span></button>
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å®—æ•™å£°ä¹ä½œå“æ€»è°±', this)"><div>å®—æ•™å£°ä¹ä½œå“æ€»è°±</div><span class="badge bg-light text-dark count-badge" data-cat="å®—æ•™å£°ä¹ä½œå“æ€»è°±">0</span></button>
                    </div>
                     <div class="mt-3 list-group list-group-flush category-group">
                         <div class="py-2 bg-light text-center small text-muted fw-bold border-top border-bottom font-serif">OTHERS</div>
                         <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å…¶ä»–', this)">ğŸ“š å…¶ä»– <span class="badge bg-light text-dark count-badge" data-cat="å…¶ä»–">0</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container content-section" id="mainContentArea">
        <div class="card shadow-sm border-0 mb-4" style="background: white; border-radius: 12px;">
            <div class="card-body py-3">
                <div class="row align-items-center g-3">
                    <div class="col-md-2"><input class="form-control form-control-sm border-0 bg-light" list="composerOptions" id="composerInput" placeholder="ğŸ‘¤ ä½œæ›²å®¶ Composer" oninput="applyFilters()"><datalist id="composerOptions"></datalist></div>
                    <div class="col-md-2"><input class="form-control form-control-sm border-0 bg-light" list="voiceOptions" id="voiceInput" placeholder="ğŸ» ç¼–åˆ¶/å£°éƒ¨ Voice" oninput="applyFilters()"><datalist id="voiceOptions"></datalist></div>
                    <div class="col-md-2"><select id="languageSelect" class="form-select form-select-sm border-0 bg-light" onchange="applyFilters()"><option value="all">ğŸŒ æ‰€æœ‰è¯­è¨€ Language</option></select></div>
                    <div class="col-md-3 border-start ps-4"><select id="sortSelect" class="form-select form-select-sm fw-bold text-primary border-0" onchange="applyFilters()"><option value="date_desc">ğŸ“… ä¸Šä¼ æ—¶é—´ (Newest)</option><option value="date_asc">ğŸ“… ä¸Šä¼ æ—¶é—´ (Oldest)</option><option value="title_asc">ğŸ”¤ æŒ‰æ›²å (A-Z)</option><option value="composer_asc">ğŸ‘¤ æŒ‰ä½œæ›²å®¶ (A-Z)</option></select></div>
                    <div class="col-md-auto ms-auto"><button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="resetFilters()">ğŸ”„ é‡ç½® Reset</button></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="recentSection" class="mb-5">
                    <h5 class="mb-4 font-serif fw-bold" style="color: #264653; border-left: 4px solid #e76f51; padding-left: 10px;">ğŸ†• Recent Additions</h5>
                    <div class="row row-cols-1 row-cols-md-3 g-4" id="recentList"></div>
                </div>
                <div id="listSection">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 id="listTitle" class="fw-bold font-serif display-6" style="font-size: 1.5rem;">ğŸ“š Catalogue</h4>
                        <span class="badge rounded-pill" style="background-color: #e9c46a; color: #333;" id="filteredCount">0 Scores</span>
                    </div>
                    <div class="card shadow-sm border-0" style="border-radius: 12px; overflow: hidden;">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 table-custom">
                                <thead class="bg-light"><tr><th width="40%" class="ps-4 py-3">Title / Work</th><th width="20%">Composer</th><th width="10%">Lang</th><th width="15%">Category</th><th class="text-end pe-4">Action</th></tr></thead>
                                <tbody id="mainTableBody" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                    <nav aria-label="Page navigation" class="mt-5" id="paginationNav"><ul class="pagination justify-content-center" id="paginationUl"></ul></nav>
                    <div id="noResult" class="text-center p-5 text-muted" style="display:none;"><div class="fs-1 mb-3">ğŸ§</div><h4 class="font-serif">No scores found</h4><p>Try adjusting your filters.</p></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center"><h4 class="text-white mb-3 font-serif">Maotong's Library</h4><p class="mb-4 text-white-50 small">Designed for classical vocalists & musicians.</p><div class="d-inline-block border-top border-secondary pt-4 mt-2"><p class="small text-muted mb-0">&copy; 2023-2025 Yu Maotong. All Rights Reserved.<br><span style="font-size: 0.8em; opacity: 0.5;">For educational purposes only.</span></p></div></div>
    </footer>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="height: 90vh; border-radius: 16px; overflow: hidden;">
                <div class="modal-header border-0 bg-light">
                    <h5 class="modal-title fw-bold font-serif">Score Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row h-100 g-0">
                        <div class="col-md-3 p-4 bg-white border-end overflow-auto">
                            <span class="badge bg-primary mb-3" id="mCategory" style="background-color: #264653 !important;"></span>
                            <h3 id="mTitle" class="mb-2 fw-bold text-dark font-serif"></h3>
                            <p class="mb-4 text-muted fst-italic"><span id="mWork" class="fs-6">-</span></p>
                            <div class="card mb-4 border-0 bg-light rounded-3 p-3">
                                <ul class="list-unstyled mb-0 small gap-2 d-flex flex-column">
                                    <li>ğŸ‘¤ <strong>Composer:</strong> <span id="mComposer"></span></li>
                                    <li>ğŸ—£ï¸ <strong>Language:</strong> <span id="mLanguage"></span></li>
                                    <li>ğŸ¹ <strong>Key:</strong> <span id="mTonality"></span></li>
                                    <li>ğŸ‘¥ <strong>Voice:</strong> <span id="mVoice"></span></li>
                                    <li>ğŸ“… <strong>Added:</strong> <span id="mDate"></span></li>
                                </ul>
                            </div>
                            
                            <button id="btnReadLyrics" class="btn btn-outline-dark w-100 py-2 mb-3 shadow-sm rounded-pill fw-bold" style="display:none;" onclick="openLyricsReader()">
                                ğŸ“– Read Libretto / å‰§æœ¬
                            </button>

                            <a id="mDownload" href="#" class="btn btn-primary w-100 py-2 shadow-sm rounded-pill" download>â¬‡ï¸ Download PDF</a>
                            <div class="mt-4 pt-3 border-top text-center text-muted small">Please delete within 24 hours after study.</div>
                        </div>
                        <div class="col-md-9 bg-secondary position-relative">
                            <iframe id="mPreview" src="" width="100%" height="100%" style="border:none;"></iframe>
                            <div id="noPreview" class="d-flex flex-column align-items-center justify-content-center h-100 text-white" style="display:none;"><div class="fs-1 mb-3">ğŸ“„</div><p class="fs-5">No Preview Available</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="readerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header border-bottom shadow-sm">
                    <div class="d-flex align-items-center">
                         <h5 class="modal-title fw-bold font-serif me-3" id="readerTitle">Libretto Reader</h5>
                         <span class="badge bg-secondary" id="readerComposer"></span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0" style="background-color: #fcfcfc;">
                    <div class="container h-100">
                        <div class="row h-100">
                            <div class="col-md-6 h-100 overflow-auto reader-text-col reader-original">
                                <h6 class="text-muted text-uppercase small fw-bold mb-4 border-bottom pb-2">Original Text</h6>
                                <div id="readerOriginalText">Loading...</div>
                            </div>
                            <div class="col-md-6 h-100 overflow-auto reader-text-col reader-translation">
                                <h6 class="text-muted text-uppercase small fw-bold mb-4 border-bottom pb-2">Chinese Translation</h6>
                                <div id="readerTransText">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="logModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content" style="border-radius: 12px;"><div class="modal-header border-0"><h5 class="modal-title fw-bold font-serif">Recent Updates</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="logBody"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>document.write('<script src="js/data.js?v=' + new Date().getTime() + '"><\/script>');</script>
    <script>
        let filters = { category: 'all', composer: '', language: 'all', voice: '', search: '' };
        let sortType = 'date_desc';
        let currentPage = 1;
        const itemsPerPage = 15;
        let currentLyricsId = null; // è®°å½•å½“å‰æ­£åœ¨æŸ¥çœ‹çš„æ­Œè¯ID

        // åˆ«åä¸é¢œè‰²é…ç½®
        const composerAliases = {
            "Mozart": "è«æ‰ç‰¹ Wolfgang Amadeus æ²ƒå°”å¤«å†ˆ é˜¿ç›è¿ªä¹Œæ–¯", "DvoÅ™Ã¡k": "Dvorak å¾·æ²ƒå¤å…‹ Antonin å®‰ä¸œå®",
            "Bach": "å·´èµ« J.S.Bach Johann Sebastian", "Beethoven": "è´å¤šèŠ¬ Ludwig van è·¯å¾·ç»´å¸Œ",
            "Schubert": "èˆ’ä¼¯ç‰¹ Franz å¼—æœ—èŒ¨", "Schumann": "èˆ’æ›¼ Robert ç½—ä¼¯ç‰¹",
            "Tchaikovsky": "æŸ´å¯å¤«æ–¯åŸº Pyotr Ilyich", "Rachmaninoff": "æ‹‰èµ«ç›å°¼è¯ºå¤« Rachmaninov Sergey",
            "FaurÃ©": "Faure ä½›ç‘ Gabriel", "Debussy": "å¾·å½ªè¥¿ Claude", "Verdi": "å¨å°”ç¬¬ Giuseppe",
            "Puccini": "æ™®å¥‘å°¼ Giacomo", "Wagner": "ç“¦æ ¼çº³ Richard", "Mahler": "é©¬å‹’ Gustav", "Strauss": "æ–½ç‰¹åŠ³æ–¯ Richard Johann"
        };
// index.html ä¸­çš„ categoryMap
const categoryMap = { 
    'æ­Œå‰§å’å¹è°ƒ': 'bg-opera', 
    'æ­Œå‰§é‡å”±': 'bg-opera-ens',
    
    // âœ… æ–°å¢æ˜ å°„
    'å®—æ•™å£°ä¹ä½œå“': 'bg-oratorio', 
    'éŸ³ä¹ä¼šå’å¹è°ƒ/ä¸–ä¿—åº·å¡”å¡”': 'bg-solo', // ç»™ä¸–ä¿—åº·å¡”å¡”ä¸€ä¸ªé¢œè‰²ï¼Œæˆ–è€…å¤ç”¨ bg-solo
    
    'è‰ºæœ¯æ­Œæ›²': 'bg-artsong', 
    'è‰ºæœ¯æ­Œæ›²é‡å”±': 'bg-artsong-ens',
    'éŸ³ä¹å‰§é€‰æ®µ': 'bg-musical',
    'éŸ³ä¹å‰§é‡å”±': 'bg-musical-ens',
    'åˆå”±ä½œå“': 'bg-choral', 
    'å£°ä¹å¥—æ›²': 'bg-cycle', 
    'ä¹è°±ä¹¦': 'bg-book', 
    'ä¹è°±ä¹¦/æ›²é›†': 'bg-book',
    'å™¨ä¹ç‹¬å¥': 'bg-inst-solo', 
    'å®¤å†…ä¹': 'bg-chamber', 
    'æ­Œå‰§æ€»è°±': 'bg-score-opera', 
    'ç®¡å¼¦ä¹/äº¤å“æ›²': 'bg-score-orch', 
    'åå¥æ›²æ€»è°±': 'bg-score-con', 
    'å®—æ•™å£°ä¹ä½œå“æ€»è°±': 'bg-score-sac',
    'å…¶ä»–': 'bg-other'
};
        window.addEventListener('load', () => {
            if (typeof musicData === 'undefined') { document.getElementById('recentList').innerHTML = '<div class="alert alert-light w-100 text-center font-serif">Loading library data...</div>'; return; }
            initStatsAndDropdowns(); renderRecent(); applyFilters();
            document.getElementById('searchInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') performSearch(); });
        });

        function normalizeStr(str) { if (!str) return ""; return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
        function performSearch() { const val = document.getElementById('searchInput').value; filters.search = val; if(val.length > 0) { document.getElementById('mainContentArea').scrollIntoView({ behavior: 'smooth' }); } applyFilters(); }

        function initStatsAndDropdowns() {
            document.getElementById('statTotal').innerText = musicData.length;
            const composers = [...new Set(musicData.map(m => m.composer).filter(c => c))].sort((a, b) => a.localeCompare(b));
            const languages = [...new Set(musicData.map(m => m.language).filter(l => l))].sort();
            const voiceTypes = [...new Set(musicData.map(m => m.voice_types).filter(v => v))].sort();
            document.getElementById('statComposer').innerText = composers.length;
            const composerDataList = document.getElementById('composerOptions'); composers.forEach(c => { composerDataList.innerHTML += `<option value="${c}">`; });
            const langSelect = document.getElementById('languageSelect'); languages.forEach(l => { langSelect.innerHTML += `<option value="${l}">${l}</option>`; });
            const voiceDataList = document.getElementById('voiceOptions'); voiceTypes.forEach(v => { voiceDataList.innerHTML += `<option value="${v}">`; });
            document.querySelectorAll('.count-badge').forEach(badge => { const cat = badge.getAttribute('data-cat'); const count = musicData.filter(m => m.category === cat).length; badge.innerText = count; if(count === 0) badge.classList.add('opacity-25'); });
        }

        function applyFilters() {
            filters.composer = document.getElementById('composerInput').value; filters.language = document.getElementById('languageSelect').value;
            filters.voice = document.getElementById('voiceInput').value; sortType = document.getElementById('sortSelect').value;
            const searchBase = normalizeStr(filters.search); const searchComposer = normalizeStr(filters.composer); const searchVoice = normalizeStr(filters.voice);

            let result = musicData.filter(item => {
                const itemTitle = normalizeStr(item.title); const itemComposer = normalizeStr(item.composer); const itemWork = normalizeStr(item.work); const itemVoice = normalizeStr(item.voice_types);
                let composerKeywords = itemComposer; if (composerAliases[item.composer]) { composerKeywords += " " + normalizeStr(composerAliases[item.composer]); }
                const fullSearchableText = `${itemTitle} ${composerKeywords} ${itemWork}`;
                return (filters.category === 'all' || item.category === filters.category) && (filters.language === 'all' || item.language === filters.language) && (filters.composer === '' || composerKeywords.includes(searchComposer)) && (filters.voice === '' || (item.voice_types && itemVoice.includes(searchVoice))) && (filters.search === '' || fullSearchableText.includes(searchBase));
            });

            result.sort((a, b) => {
                if (sortType === 'date_desc') return b.id - a.id; if (sortType === 'date_asc') return a.id - b.id;
                if (sortType === 'title_asc') return a.title.localeCompare(b.title); if (sortType === 'composer_asc') return a.composer.localeCompare(b.composer); return 0;
            });
            renderPaginationTable(result);
            document.getElementById('recentSection').style.display = (filters.search || filters.composer || filters.language !== 'all' || filters.voice || filters.category !== 'all') ? 'none' : 'block';
        }

        function getCategoryClass(cat) { for (const key in categoryMap) { if (cat.includes(key)) return categoryMap[key]; } return 'bg-other'; }

        function renderPaginationTable(data) {
            const total = data.length; const pages = Math.ceil(total / itemsPerPage);
            if (currentPage > pages) currentPage = pages || 1; if (currentPage < 1) currentPage = 1;
            const start = (currentPage - 1) * itemsPerPage; const pageData = data.slice(start, start + itemsPerPage);
            const tbody = document.getElementById('mainTableBody'); document.getElementById('filteredCount').innerText = total + ' Scores';
            if (total === 0) { tbody.innerHTML = ''; document.getElementById('noResult').style.display = 'block'; document.getElementById('paginationNav').style.display = 'none'; return; }
            document.getElementById('noResult').style.display = 'none'; document.getElementById('paginationNav').style.display = 'block';

            let html = '';
            pageData.forEach(item => {
                let badgeClass = getCategoryClass(item.category);
                let tonalityBadge = item.tonality ? `<span class="badge bg-light text-dark border ms-2" style="font-size:0.7rem; opacity: 0.7;">${item.tonality}</span>` : '';
                let voiceBadge = item.voice_types ? `<span class="badge bg-secondary ms-1" style="font-size:0.7rem; opacity: 0.8;">${item.voice_types}</span>` : '';
                // å¦‚æœæœ‰æ­Œè¯ï¼Œæ˜¾ç¤ºä¸€ä¸ªå°å›¾æ ‡
                let lyricIcon = item.has_lyrics ? `<span class="badge bg-info text-dark ms-1" style="font-size:0.6rem" title="Contains Libretto">ğŸ“–</span>` : '';

                html += `<tr onclick="openDetail(${item.id})" class="hover-row"><td class="ps-4"><div class="fw-bold text-dark" style="font-family: 'Lato', sans-serif;">${item.title} ${tonalityBadge} ${voiceBadge} ${lyricIcon}</div>${item.work ? `<small class="text-muted fst-italic">from ${item.work}</small>` : ''}</td><td><span class="fw-medium text-secondary">${item.composer}</span></td><td>${item.language ? `<span class="text-muted small">${item.language}</span>` : '-'}</td><td><span class="badge badge-custom ${badgeClass}">${item.category}</span></td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm">View</button></td></tr>`;
            });
            tbody.innerHTML = html; renderPaginationControls(pages);
        }

        function renderPaginationControls(pages) {
            const ul = document.getElementById('paginationUl'); let html = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link border-0 bg-transparent" href="#" onclick="changePage(${currentPage - 1}); return false;">Prev</a></li><li class="page-item disabled"><span class="page-link border-0 bg-transparent fw-bold text-dark">${currentPage} / ${pages}</span></li><li class="page-item ${currentPage === pages ? 'disabled' : ''}"><a class="page-link border-0 bg-transparent" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a></li>`; ul.innerHTML = html;
        }
        window.changePage = (p) => { currentPage = p; applyFilters(); document.getElementById('listSection').scrollIntoView({ behavior: 'smooth' }); };
        function renderRecent() {
            const list = document.getElementById('recentList'); const recents = musicData.slice(0, 3); let html = '';
            recents.forEach(item => { html += `<div class="col"><div class="card h-100 border-0 shadow-sm cursor-pointer hover-card" style="border-radius: 12px; overflow:hidden;" onclick="openDetail(${item.id})"><div class="card-body bg-white"><span class="badge bg-light text-muted mb-2 border">${item.category}</span><h6 class="card-title text-truncate fw-bold text-dark font-serif" style="font-size: 1.1rem;">${item.title}</h6><p class="card-text small text-secondary mb-0">${item.composer}</p></div><div class="card-footer bg-white border-0 pt-0"><small class="text-muted" style="font-size: 0.75rem">Added: ${item.date}</small></div></div></div>`; }); list.innerHTML = html;
        }
        window.filterCategory = (cat, btn) => { currentPage = 1; filters.category = cat; document.querySelectorAll('.category-group button').forEach(b => b.classList.remove('active-cat')); if (cat !== 'all') btn.classList.add('active-cat'); document.getElementById('listTitle').innerText = cat === 'all' ? 'ğŸ“š Catalogue' : `ğŸ“‚ ${cat}`; document.getElementById('mainContentArea').scrollIntoView({ behavior: 'smooth' }); applyFilters(); };
        window.resetFilters = () => { currentPage = 1; filters = { category: 'all', composer: '', language: 'all', voice: '', search: '' }; document.getElementById('searchInput').value = ''; document.getElementById('composerInput').value = ''; document.getElementById('languageSelect').value = 'all'; document.getElementById('voiceInput').value = ''; document.querySelectorAll('.category-group button').forEach(b => b.classList.remove('active-cat')); document.getElementById('listTitle').innerText = 'ğŸ“š Catalogue'; document.getElementById('mainContentArea').scrollIntoView({ behavior: 'smooth' }); applyFilters(); };
        window.showLogModal = () => { const body = document.getElementById('logBody'); if (typeof changeLog === 'undefined' || changeLog.length === 0) { body.innerHTML = '<p class="text-muted text-center my-4">æš‚æ— åŠ¨æ€è®°å½•</p>'; } else { let html = '<ul class="list-group list-group-flush">'; changeLog.forEach(log => { let badgeClass = log.type === 'add' ? 'bg-success' : (log.type === 'update' ? 'bg-primary' : 'bg-danger'); let typeText = log.type === 'add' ? 'Added' : (log.type === 'update' ? 'Edited' : 'Deleted'); html += `<li class="list-group-item d-flex justify-content-between align-items-start px-0"><div class="ms-2 me-auto"><div class="fw-bold small text-muted mb-1">${log.date}</div>${log.msg}</div><span class="badge ${badgeClass} rounded-pill">${typeText}</span></li>`; }); html += '</ul>'; body.innerHTML = html; } new bootstrap.Modal(document.getElementById('logModal')).show(); };

        // === è¯¦æƒ…é¡µä¸æ­Œè¯é€»è¾‘ ===
        window.openDetail = function(id) {
            const item = musicData.find(m => m.id === id); if (!item) return;
            document.getElementById('mTitle').innerText = item.title; document.getElementById('mWork').innerText = item.work || '-'; document.getElementById('mComposer').innerText = item.composer; document.getElementById('mCategory').innerText = item.category; document.getElementById('mLanguage').innerText = item.language || '-'; document.getElementById('mDate').innerText = item.date || '-'; document.getElementById('mTonality').innerText = item.tonality || '-';
            let voiceInfo = '-'; if(item.voice_count || item.voice_types) voiceInfo = `${item.voice_count || ''} ${item.voice_types ? '('+item.voice_types+')' : ''}`; document.getElementById('mVoice').innerText = voiceInfo;
            document.getElementById('mDownload').href = `scores/${item.filename}`;
            
            // æ­Œè¯æŒ‰é’®é€»è¾‘
            const btn = document.getElementById('btnReadLyrics');
            if (item.has_lyrics) {
                btn.style.display = 'block';
                currentLyricsId = id; // ä¿å­˜å½“å‰IDä¾›è¯»å–ä½¿ç”¨
            } else {
                btn.style.display = 'none';
                currentLyricsId = null;
            }

            const previewFrame = document.getElementById('mPreview'); const noPreview = document.getElementById('noPreview');
            if (item.filename.toLowerCase().endsWith('.pdf')) { previewFrame.src = `scores/${item.filename}`; previewFrame.style.display = 'block'; noPreview.style.display = 'none'; } else { previewFrame.style.display = 'none'; noPreview.style.display = 'flex'; }
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // æ‰“å¼€æ­Œè¯é˜…è¯»å™¨
        window.openLyricsReader = function() {
            if (!currentLyricsId) return;
            
            // 1. è·å–åŸºæœ¬ä¿¡æ¯å¡«å……æ ‡é¢˜
            const item = musicData.find(m => m.id === currentLyricsId);
            document.getElementById('readerTitle').innerText = item.title;
            document.getElementById('readerComposer').innerText = item.composer;

            // 2. æ˜¾ç¤ºLoading
            document.getElementById('readerOriginalText').innerText = 'Loading...';
            document.getElementById('readerTransText').innerText = 'Loading...';

            // 3. æ‰“å¼€å…¨å±æ¨¡æ€æ¡†
            new bootstrap.Modal(document.getElementById('readerModal')).show();

            // 4. å¼‚æ­¥è·å–æ­Œè¯å†…å®¹
            // åŠ ä¸Šæ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            fetch(`lyrics/${currentLyricsId}.json?v=${new Date().getTime()}`)
                .then(response => {
                    if (!response.ok) throw new Error("Lyrics not found");
                    return response.json();
                })
                .then(data => {
                    document.getElementById('readerOriginalText').innerText = data.original || 'No original text provided.';
                    document.getElementById('readerTransText').innerText = data.translation || 'No translation provided.';
                })
                .catch(err => {
                    document.getElementById('readerOriginalText').innerText = 'Error loading lyrics.';
                    document.getElementById('readerTransText').innerText = '';
                });
        }
    </script>
</body>
</html>