<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>äºèŒ‚åŒçš„ä¹è°±åº“ | æµ‹è¯•ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f4f6f9; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container { flex: 1; }
        .hover-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.1)!important; 
            transition: all 0.2s;
        }
        .cursor-pointer { cursor: pointer; }
        .filter-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        footer {
            background-color: #2c3e50;
            color: #bdc3c7;
            padding: 3rem 0;
            margin-top: 4rem;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm" style="background: linear-gradient(to right, #2c3e50, #4ca1af);">
        <div class="container">
            <span class="navbar-brand mb-0 h1 fw-bold">ğŸ¹ äºèŒ‚åŒçš„ä¹è°±åº“</span>
            <div class="d-flex align-items-center">
                <span class="badge bg-warning text-dark me-2">Beta v2.1</span>
                <span class="navbar-text text-white-50 small d-none d-md-block">
                    By Yu Maotong
                </span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            
            <div class="col-lg-3 mb-4">
                
                <div class="card bg-primary text-white mb-4 shadow-sm border-0">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">æ”¶å½•ä¹è°±</h6>
                                <h3 class="mb-0 fw-bold" id="statTotal">0</h3>
                            </div>
                            <div class="text-end border-start ps-3">
                                <h6 class="mb-0 text-white-50">ä½œæ›²å®¶</h6>
                                <h3 class="mb-0 fw-bold" id="statComposer">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h5 class="fw-bold mb-3 text-secondary">ğŸ” ç­›é€‰ä¸æŸ¥æ‰¾</h5>
                    
                    <div class="mb-3">
                        <label class="form-label small text-muted">å…³é”®è¯æœç´¢</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="æ›²åã€ä½œå“å·...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">ä½œæ›²å®¶ (æ”¯æŒæœç´¢)</label>
                        <input class="form-control" list="composerOptions" id="composerInput" placeholder="è¾“å…¥æˆ–é€‰æ‹©..." oninput="applyFilters()">
                        <datalist id="composerOptions">
                            </datalist>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">è¯­è¨€</label>
                        <select id="languageSelect" class="form-select" onchange="applyFilters()">
                            <option value="all">æ‰€æœ‰è¯­è¨€</option>
                            </select>
                    </div>

                    <button class="btn btn-outline-secondary w-100 btn-sm" onclick="resetFilters()">ğŸ”„ é‡ç½®æ‰€æœ‰ç­›é€‰</button>
                </div>

                <div class="list-group shadow-sm mb-4" id="categoryList">
                    <button class="list-group-item list-group-item-action active fw-bold" onclick="filterCategory('all', this)">
                        ğŸ“‚ æ‰€æœ‰åˆ†ç±»
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('æ­Œå‰§å’å¹è°ƒ', this)">
                        æ­Œå‰§å’å¹è°ƒ <span class="badge bg-light text-dark rounded-pill count-badge" data-cat="æ­Œå‰§å’å¹è°ƒ">0</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('è‰ºæœ¯æ­Œæ›²', this)">
                        è‰ºæœ¯æ­Œæ›² <span class="badge bg-light text-dark rounded-pill count-badge" data-cat="è‰ºæœ¯æ­Œæ›²">0</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('åˆå”±ä½œå“', this)">
                        åˆå”±ä½œå“ <span class="badge bg-light text-dark rounded-pill count-badge" data-cat="åˆå”±ä½œå“">0</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å™¨ä¹ç‹¬å¥', this)">
                        å™¨ä¹ç‹¬å¥ <span class="badge bg-light text-dark rounded-pill count-badge" data-cat="å™¨ä¹ç‹¬å¥">0</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å®¤å†…ä¹', this)">
                        å®¤å†…ä¹ <span class="badge bg-light text-dark rounded-pill count-badge" data-cat="å®¤å†…ä¹">0</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="filterCategory('å…¶ä»–', this)">
                        å…¶ä»– <span class="badge bg-light text-dark rounded-pill count-badge" data-cat="å…¶ä»–">0</span>
                    </button>
                </div>
            </div>

            <div class="col-lg-9">
                <div id="recentSection" class="mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h4 class="mb-0 text-primary">ğŸ†• æœ€è¿‘å…¥åº“</h4>
                    </div>
                    <div class="row row-cols-1 row-cols-md-3 g-3" id="recentList"></div>
                </div>

                <div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 id="listTitle" class="fw-bold">ğŸ“š ä¹è°±åˆ—è¡¨</h4>
                        <span class="badge bg-secondary" id="filteredCount">0 é¦–</span>
                    </div>
                    
                    <div class="card shadow-sm border-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-secondary small text-uppercase">
                                    <tr>
                                        <th width="40%" class="ps-4">æ›²å / ä½œå“</th>
                                        <th width="20%">ä½œæ›²å®¶</th>
                                        <th width="15%">è¯­è¨€</th>
                                        <th width="15%">åˆ†ç±»</th>
                                        <th class="text-end pe-4">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="mainTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="noResult" class="text-center p-5 text-muted" style="display:none;">
                        <div class="fs-1 mb-3">ğŸ§</div>
                        <h4>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¹è°±</h4>
                        <p>è¯•è¯•è°ƒæ•´ä¸€ä¸‹ç­›é€‰æ¡ä»¶ï¼Ÿ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <h5 class="text-white mb-3">äºèŒ‚åŒçš„ä¹è°±åº“</h5>
            <p class="mb-3 text-warning">ğŸ‰ æœ¬ç«™èµ„æºä»…ä¾›ä¸ªäººå­¦ä¹ äº¤æµï¼Œä¸¥ç¦å•†ç”¨</p>
            <hr style="border-color: #495057; width: 50%; margin: 1rem auto;">
            <p class="small text-muted mb-0">
                å¦‚æœå‘ç°ä¾µæƒï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼ˆäºèŒ‚åŒï¼‰ç«‹å³åˆ é™¤ã€‚<br>
                &copy; 2023-2025 Yu Maotong. All Rights Reserved.
            </p>
        </div>
    </footer>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="height: 90vh;">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">ä¹è°±è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row h-100 g-0">
                        <div class="col-md-3 p-4 bg-light border-end overflow-auto">
                            <span class="badge bg-primary mb-2" id="mCategory"></span>
                            <h3 id="mTitle" class="mb-3 fw-bold text-dark"></h3>
                            <p class="mb-3"><strong class="text-muted">æ‰€å±ä½œå“ï¼š</strong><br><span id="mWork" class="fs-5">-</span></p>
                            <div class="card mb-3 border-0 shadow-sm">
                                <ul class="list-group list-group-flush small">
                                    <li class="list-group-item">ğŸ‘¤ <strong>ä½œæ›²å®¶ï¼š</strong> <span id="mComposer"></span></li>
                                    <li class="list-group-item">ğŸ—£ï¸ <strong>è¯­è¨€ï¼š</strong> <span id="mLanguage"></span></li>
                                    <li class="list-group-item">ğŸ“… <strong>æ”¶å½•æ—¥æœŸï¼š</strong> <span id="mDate"></span></li>
                                </ul>
                            </div>
                            <a id="mDownload" href="#" class="btn btn-success w-100 py-2 fw-bold shadow-sm" download>â¬‡ï¸ ä¸‹è½½ PDF/MIDI</a>
                        </div>
                        <div class="col-md-9 bg-secondary position-relative">
                            <iframe id="mPreview" src="" width="100%" height="100%" style="border:none;"></iframe>
                            <div id="noPreview" class="d-flex flex-column align-items-center justify-content-center h-100 text-white" style="display:none;">
                                <div class="fs-1 mb-3">ğŸ“„</div>
                                <p class="fs-5">æ­¤æ–‡ä»¶æš‚ä¸æ”¯æŒé¢„è§ˆ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/data.js"></script>
    
    <script>
        let filters = { category: 'all', composer: '', language: 'all', search: '' };

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof musicData === 'undefined') {
                document.getElementById('recentList').innerHTML = 'è¯·å…ˆæ·»åŠ æ•°æ®';
                return;
            }
            initStatsAndDropdowns();
            renderRecent();
            applyFilters();

            // æœç´¢æ¡†ç›‘å¬
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filters.search = e.target.value.toLowerCase();
                applyFilters();
            });
        });

        function initStatsAndDropdowns() {
            document.getElementById('statTotal').innerText = musicData.length;
            
            // æå–å”¯ä¸€ä½œæ›²å®¶å¹¶æŒ‰å­—æ¯æ’åº
            const composers = [...new Set(musicData.map(m => m.composer).filter(c => c))].sort((a, b) => a.localeCompare(b));
            const languages = [...new Set(musicData.map(m => m.language).filter(l => l))].sort();

            document.getElementById('statComposer').innerText = composers.length;

            // å¡«å……ä½œæ›²å®¶ DataList
            const composerDataList = document.getElementById('composerOptions');
            composers.forEach(c => {
                composerDataList.innerHTML += `<option value="${c}">`;
            });

            // å¡«å……è¯­è¨€ä¸‹æ‹‰æ¡†
            const langSelect = document.getElementById('languageSelect');
            languages.forEach(l => {
                langSelect.innerHTML += `<option value="${l}">${l}</option>`;
            });

            // å¾½ç« è®¡æ•°
            document.querySelectorAll('.count-badge').forEach(badge => {
                const cat = badge.getAttribute('data-cat');
                const count = musicData.filter(m => m.category === cat).length;
                badge.innerText = count;
                if(count === 0) badge.classList.add('text-muted', 'bg-transparent');
            });
        }

        function applyFilters() {
            // è·å–è¾“å…¥æ¡†çš„å€¼
            filters.composer = document.getElementById('composerInput').value;
            filters.language = document.getElementById('languageSelect').value;

            const result = musicData.filter(item => {
                const matchCat = filters.category === 'all' || item.category === filters.category;
                
                // ä½œæ›²å®¶åŒ¹é…ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰ï¼šè¾“å…¥ "Moz" ä¹Ÿèƒ½åŒ¹é… "Mozart"
                // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œåˆ™åŒ¹é…æ‰€æœ‰
                const matchComp = filters.composer === '' || item.composer.toLowerCase().includes(filters.composer.toLowerCase());
                
                const matchLang = filters.language === 'all' || item.language === filters.language;
                const matchSearch = item.title.toLowerCase().includes(filters.search) || 
                                    item.composer.toLowerCase().includes(filters.search) ||
                                    (item.work && item.work.toLowerCase().includes(filters.search));
                
                return matchCat && matchComp && matchLang && matchSearch;
            });

            renderTable(result);
            
            // æœ‰ä»»ä½•ç­›é€‰æ¡ä»¶æ—¶éšè—â€œæœ€è¿‘æ›´æ–°â€
            const isFiltering = filters.search || filters.composer || filters.language !== 'all';
            document.getElementById('recentSection').style.display = isFiltering ? 'none' : 'block';
        }

        function renderTable(data) {
            const tbody = document.getElementById('mainTableBody');
            const noResult = document.getElementById('noResult');
            document.getElementById('filteredCount').innerText = data.length + ' é¦–';

            if (data.length === 0) {
                tbody.innerHTML = '';
                noResult.style.display = 'block';
                return;
            }
            noResult.style.display = 'none';

            let html = '';
            data.forEach(item => {
                let badgeClass = 'bg-light text-dark border';
                if(item.category === 'æ­Œå‰§å’å¹è°ƒ') badgeClass = 'bg-info bg-opacity-10 text-info border-info border-opacity-25';
                
                html += `
                <tr onclick="openDetail(${item.id})" class="cursor-pointer">
                    <td class="ps-4">
                        <div class="fw-bold text-dark">${item.title}</div>
                        ${item.work ? `<small class="text-muted">ã€Š${item.work}ã€‹</small>` : ''}
                    </td>
                    <td><span class="fw-medium">${item.composer}</span></td>
                    <td>${item.language ? `<span class="badge bg-secondary bg-opacity-10 text-secondary">${item.language}</span>` : '-'}</td>
                    <td><span class="badge ${badgeClass}">${item.category}</span></td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-3">æŸ¥çœ‹</button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderRecent() {
            const list = document.getElementById('recentList');
            const recents = musicData.slice(0, 3);
            let html = '';
            recents.forEach(item => {
                html += `
                <div class="col">
                    <div class="card h-100 hover-card border-0 bg-white shadow-sm cursor-pointer" onclick="openDetail(${item.id})">
                        <div class="card-body">
                            <span class="badge bg-light text-muted mb-2">${item.category}</span>
                            <h6 class="card-title text-truncate fw-bold text-dark">${item.title}</h6>
                            <p class="card-text small text-secondary mb-0">${item.composer}</p>
                        </div>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        }

        window.filterCategory = function(cat, btn) {
            filters.category = cat;
            document.querySelectorAll('#categoryList button').forEach(b => {
                b.classList.remove('active', 'fw-bold');
                const badge = b.querySelector('.badge');
                if(badge) {
                    badge.classList.remove('bg-light', 'text-dark');
                    badge.classList.add('bg-light', 'text-dark'); 
                }
            });
            btn.classList.add('active', 'fw-bold');
            document.getElementById('listTitle').innerText = cat === 'all' ? 'ğŸ“š æ‰€æœ‰ä¹è°±' : `ğŸ“‚ ${cat}`;
            applyFilters();
        }

        window.resetFilters = function() {
            filters = { category: 'all', composer: '', language: 'all', search: '' };
            document.getElementById('searchInput').value = '';
            document.getElementById('composerInput').value = ''; // æ¸…ç©ºä½œæ›²å®¶è¾“å…¥
            document.getElementById('languageSelect').value = 'all';
            document.querySelector('#categoryList button').click();
        }

        window.openDetail = function(id) {
            const item = musicData.find(m => m.id === id);
            if (!item) return;

            document.getElementById('mTitle').innerText = item.title;
            document.getElementById('mWork').innerText = item.work || '-';
            document.getElementById('mComposer').innerText = item.composer;
            document.getElementById('mCategory').innerText = item.category;
            document.getElementById('mLanguage').innerText = item.language || '-';
            document.getElementById('mDate').innerText = item.date || '-';
            
            const filePath = `scores/${item.filename}`;
            document.getElementById('mDownload').href = filePath;

            const previewFrame = document.getElementById('mPreview');
            const noPreview = document.getElementById('noPreview');
            
            if (item.filename.toLowerCase().endsWith('.pdf')) {
                previewFrame.src = filePath;
                previewFrame.style.display = 'block';
                noPreview.style.display = 'none';
            } else {
                previewFrame.style.display = 'none';
                noPreview.style.display = 'flex';
            }
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }
    </script>
</body>
</html>